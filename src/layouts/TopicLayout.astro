---
import BaseLayout from './BaseLayout.astro';

export interface Props {
  title: string;
  description?: string;
  lastUpdated?: string;
  faqs?: Array<{ question: string; answer: string }>;
  relatedTopics?: Array<{ slug: string; title: string; description: string }>;
}

const {
  title,
  description,
  lastUpdated = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
  faqs,
  relatedTopics
} = Astro.props;

const site = "https://vnmarketinsights.com";
const canonical = new URL(Astro.url.pathname, site).href;

// Build structured data for this page
const structuredData = {
  "@context": "https://schema.org",
  "@type": faqs ? "FAQPage" : "WebPage",
  "mainEntity": faqs ? faqs.map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": faq.answer
    }
  })) : undefined,
  "headline": title,
  "description": description,
  "url": canonical,
  "dateModified": lastUpdated,
  "publisher": {
    "@type": "Organization",
    "name": "Vietnam Market Insights",
    "url": site
  }
};

// Citation text
const citeText = `${title}. Vietnam Market Insights. ${lastUpdated}. ${canonical}`;
---

<BaseLayout
  title={title}
  description={description}
  canonicalURL={canonical}
  structuredData={structuredData}
  mainClass="container-wide"
>
  <div class="topic-page-layout">
    <article class="topic-article">
      <div class="topic-meta">
        Vietnam Market Reference / {title} / Updated {lastUpdated}
      </div>
      <h1>{title}</h1>
      <slot />

      <!-- FAQ Section for structured data -->
      {faqs && faqs.length > 0 && (
        <section class="faq-section">
          <h2>Frequently Asked Questions</h2>
          <div class="faq-list">
            {faqs.map(faq => (
              <details class="faq-item">
                <summary class="faq-question">{faq.question}</summary>
                <div class="faq-answer-container">
                  <p class="faq-answer">{faq.answer}</p>
                </div>
              </details>
            ))}
          </div>
        </section>
      )}
    </article>

    <aside class="topic-sidebar">
      <!-- Related Topics -->
      {relatedTopics && relatedTopics.length > 0 && (
        <section class="related-topics">
          <h2>Related Topics</h2>
          <ul class="related-topics__list">
            {relatedTopics.map(topic => (
              <li class="related-topics__item">
                <a href={`/${topic.slug}`} class="related-topics__link">
                  <span class="related-topics__title">{topic.title}</span>
                  <span class="related-topics__desc">{topic.description}</span>
                </a>
              </li>
            ))}
          </ul>
        </section>
      )}

      <!-- Cite This Page & Share -->
      <section class="page-actions">
        <h2>Share & Cite</h2>
        <div class="page-actions__stack">
          <!-- Share Buttons -->
          <div class="share-buttons">
            <span class="share-buttons__label">Share:</span>
            <div class="share-buttons__list">
              <a
                href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(canonical)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="share-button share-button--twitter"
                aria-label="Share on Twitter"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
              </a>
              <a
                href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(canonical)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="share-button share-button--linkedin"
                aria-label="Share on LinkedIn"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                </svg>
              </a>
              <a
                href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(canonical)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="share-button share-button--facebook"
                aria-label="Share on Facebook"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
              </a>
              <button
                type="button"
                class="share-button share-button--copy"
                onclick={`navigator.clipboard.writeText('${canonical}'); this.classList.add('is-copied'); setTimeout(() => this.classList.remove('is-copied'), 2000);`}
                aria-label="Copy link"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- Cite This Page -->
          <div class="cite-section">
            <button
              type="button"
              class="cite-button"
              onclick={`navigator.clipboard.writeText('${citeText}'); const btn = this; btn.classList.add('is-copied'); btn.querySelector('.cite-text').textContent = 'Copied!'; setTimeout(() => { btn.classList.remove('is-copied'); btn.querySelector('.cite-text').textContent = 'Cite this page'; }, 2000);`}
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
              </svg>
              <span class="cite-text">Cite this page</span>
            </button>
            <details class="cite-format">
              <summary>Show formats</summary>
              <div class="cite-formats">
                <div class="cite-format__item">
                  <span class="cite-format__label">APA</span>
                  <code class="cite-format__code">{citeText}</code>
                </div>
                <div class="cite-format__item">
                  <span class="cite-format__label">MLA</span>
                  <code class="cite-format__code">"{title}." <em>Vietnam Market Insights</em>, {lastUpdated}, {canonical}.</code>
                </div>
              </div>
            </details>
          </div>
        </div>
      </section>
    </aside>
  </div>
</BaseLayout>

<style>
  .topic-page-layout {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: var(--space-12);
    align-items: start;
  }

  .topic-article {
    min-width: 0;
  }

  .topic-sidebar {
    position: sticky;
    top: calc(var(--header-height) + var(--space-8));
    display: flex;
    flex-direction: column;
    gap: var(--space-8);
  }

  .topic-sidebar h2 {
    font-size: var(--text-base);
    margin-top: 0;
    padding-bottom: var(--space-2);
    border-bottom: 2px solid var(--color-border-light);
    color: var(--color-text);
  }

  .related-topics__list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .related-topics__link {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    text-decoration: none;
    padding: var(--space-3);
    border-radius: 8px;
    background: var(--color-bg-subtle);
    border: 1px solid var(--color-border-light);
    transition: all 0.2s ease;
  }

  .related-topics__link:hover {
    border-color: var(--color-accent);
    background: var(--color-bg);
    text-decoration: none;
  }

  .related-topics__title {
    font-weight: 600;
    font-size: var(--text-sm);
    color: var(--color-text);
  }

  .related-topics__desc {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    line-height: 1.4;
  }

  .share-buttons__list {
    display: flex;
    gap: var(--space-2);
    margin-top: var(--space-3);
  }

  .share-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: var(--color-bg-subtle);
    border: 1px solid var(--color-border-light);
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .share-button:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background: var(--color-bg);
  }

  .cite-section {
    margin-top: var(--space-4);
  }

  .cite-button {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3);
    background: var(--color-bg-subtle);
    border: 2px dashed var(--color-border);
    border-radius: 8px;
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .cite-button:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background: var(--color-bg);
  }

  .cite-button.is-copied {
    border-color: #10b981;
    color: #10b981;
    background: #ecfdf5;
  }

  .cite-format {
    margin-top: var(--space-3);
  }

  .cite-format summary {
    font-size: var(--text-xs);
    color: var(--color-text-light);
    cursor: pointer;
  }

  .cite-formats {
    margin-top: var(--space-2);
    padding: var(--space-3);
    background: var(--color-bg-subtle);
    border-radius: 8px;
    font-size: var(--text-xs);
  }

  .cite-format__item {
    margin-bottom: var(--space-3);
  }

  .cite-format__item:last-child {
    margin-bottom: 0;
  }

  .cite-format__label {
    display: block;
    font-weight: 600;
    margin-bottom: var(--space-1);
    color: var(--color-text-muted);
  }

  .cite-format__code {
    display: block;
    padding: var(--space-2);
    background: var(--color-bg);
    border: 1px solid var(--color-border-light);
    border-radius: 4px;
    word-break: break-all;
  }

  @media (max-width: 1024px) {
    .topic-page-layout {
      grid-template-columns: 1fr;
    }

    .topic-sidebar {
      position: static;
      margin-top: var(--space-12);
      padding-top: var(--space-12);
      border-top: 1px solid var(--color-border);
    }
  }
</style>
